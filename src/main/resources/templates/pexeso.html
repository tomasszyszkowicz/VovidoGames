<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pexeso Board</title>
    <link rel="stylesheet" href="/styles.css" th:href="@{/styles.css}">
    <style>
        .board {
            display: grid;
            grid-gap: 10px;
            justify-content: center;
            align-items: center;
        }

        .board.easy {
            grid-template-columns: repeat(4, 120px);
        }

        .board.medium {
            grid-template-columns: repeat(6, 80px);
        }

        .board.hard {
            grid-template-columns: repeat(8, 65px);
        }

        .card {
            background-color: lightgray;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            color: lightgray;
        }

        .card.flipped {
            color: black; /* Change the text color when flipped */
        }
        /* Adjust the width and height of the cards based on the grid-template-columns */
        .board.easy .card {
            width: 120px;
            height: 120px;
        }

        .board.medium .card {
            width: 80px;
            height: 80px;
        }

        .board.hard .card {
            width: 65px;
            height: 65px;
        }
    </style>
</head>
<body>
    <div class="top-right-container">
        <p><b>Logged in as:</b></p>
        <p>Placeholder</p>
        <p>Placeholder</p>
        <a href="{% url 'logout' %}">Logout</a>
    </div>
    <div class="top-left-container">
        <p><b>Fun Games</b></p>
        <a>Home</a>
    </div>
    <div class="middle-right-container">
        <p><b>Leaderboard</b></p>
        <p>Placeholder</p>
        <p>Placeholder</p>
    </div>
    <h1>You selected level: <span th:text="${difficulty}"></span></h1>
    <div class="sub-container-wrapper">
        <div class="sub-container">
            <!-- Use Thymeleaf expression to dynamically generate cards -->
            <div class="board" th:classappend="${difficulty}">
                <div th:each="cardNumber : ${#numbers.sequence(1, difficulty == 'easy' ? 16 : difficulty == 'medium' ? 36 : 64)}" class="card">
                </div>
            </div>
        </div>
    </div>
    <div class="sub-container-wrapper">
        <div class="left-wrapper">
            <div class="sub-container">
                <p>Clicks: <span id="clicks">0</span></p>
                <p>Matches: <span id="matches">0</span></p>
            </div>
        </div>
        <div class="right-wrapper">
            <div class="sub-container">
                <a href="/pexeso-menu">Back to Menu</a>
                <a th:href="@{/pexeso-game(difficulty=${difficulty})}">Restart Game</a>

            </div>
        </div>
    </div>

    <script>

        var numberOfClicks = 0;
        var numberOfMatches = 0;

        var values = [];

        var firstFlippedCard = null;
    
        // Function to assign values to cards
        function assignCardValues() {
            var cards = document.querySelectorAll('.card');
            var randomIndexes = generateRandomIndexes(cards.length);
    
            for (var i = 0; i < cards.length; i++) {
                cards[i].textContent = values[randomIndexes[i]];
            }
        }
    
        // Function to generate random indexes for shuffling the values
        function generateRandomIndexes(length) {
            var indexes = [];
    
            for (var i = 0; i < length; i++) {
                indexes.push(i);
            }
    
            // Shuffle the indexes using Fisher-Yates algorithm
            for (var i = indexes.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                [indexes[i], indexes[j]] = [indexes[j], indexes[i]]; // Swap elements
            }
    
            return indexes;
        }
    
        // Function to flip the card and display its text content
        function flipCard() {
            var clickedCard = this; // Preserve the reference to the clicked card
            numberOfClicks++;
            document.getElementById("clicks").textContent = numberOfClicks;

            if (clickedCard.classList.contains('flipped')) {
                clickedCard.classList.remove('flipped');
            } else {
                clickedCard.classList.add('flipped');

                if (firstFlippedCard === null) {
                    // If no card is flipped, set this card as the first flipped card
                    firstFlippedCard = clickedCard;
                    firstFlippedCard.removeEventListener('click', flipCard);
                } else {
                    // If one card is already flipped, check for a match
                    if (firstFlippedCard.textContent === clickedCard.textContent) {
                        // Match found: keep both cards flipped
                        console.log("Match found!");
                        numberOfMatches++;
                        document.getElementById("matches").textContent = numberOfMatches;
                        firstFlippedCard.removeEventListener('click', flipCard);
                        clickedCard.removeEventListener('click', flipCard);
                        setTimeout(checkEndGame, 200);
                    } else {

                        var cards = document.querySelectorAll('.card');
                        cards.forEach(card => {
                            card.removeEventListener('click', flipCard);
                        });

                        setTimeout(function(card1, card2) {
                            // Remove 'flipped' class from both cards
                            card1.classList.remove('flipped');
                            card2.classList.remove('flipped');

                            // Re-enable click event for unmatched cards after the timeout
                            cards.forEach(card => {
                                if (!card.classList.contains('flipped')) {
                                    card.addEventListener('click', flipCard);
                                }
                            });
                        }, 1000, firstFlippedCard, clickedCard); // Pass cards as arguments
            }

                    // Reset the firstFlippedCard variable after checking for a match
                    firstFlippedCard = null;
                }
            }
        }

        // Function to check if the game has ended
        function checkEndGame() {
            if (numberOfMatches === values.length / 2) {
                alert("Congratulations! You have completed the game with " + numberOfClicks + " clicks.");
            }
        }

        function setupValues(){
                // Define your values array
            var easyValues = ["A", "A", "B", "B", "C", "C", "D", "D", "E", "E", "F", "F", "G", "G", "H", "H"];
            var mediumValues = ["A", "A", "B", "B", "C", "C", "D", "D", "E", "E", "F", "F", "G", "G", "H", "H", "I", "I", "J", "J", "K", "K", "L", "L", "M", "M", "N", "N", "O", "O", "P", "P", "Q", "Q", "R", "R"];
            var hardValues = ["A", "A", "B", "B", "C", "C", "D", "D", "E", "E", "F", "F", "G", "G", "H", "H", "I", "I", "J", "J", "K", "K", "L", "L", "M", "M", "N", "N", "O", "O", "P", "P", "Q", "Q", "R", "R", "S", "S", "T", "T", "U", "U", "V", "V", "W", "W", "X", "X", "Y", "Y", "Z", "Z", "1", "1", "2", "2", "3", "3", "4", "4", "5", "5", "6", "6"];

            // Create a URLSearchParams object from the current URL
            const urlParams = new URLSearchParams(window.location.search);

            // Get the 'difficulty' parameter from the URL
            const difficulty = urlParams.get('difficulty');
            switch (difficulty) {
                case 'easy':
                    values = easyValues;
                    break;
                case 'medium':
                    values = mediumValues;
                    break;
                case 'hard':
                    values = hardValues;
                    break;
            }
        }
    
        // Call the function to assign values to cards when the page loads
        window.onload = function() {
            setupValues();
            assignCardValues();
    
            // Add event listener to each card to flip it on click
            var cards = document.querySelectorAll('.card');
            cards.forEach(card => card.addEventListener('click', flipCard));
        };
    </script>
</body>
</html>
