<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/styles.css" th:href="@{/css/styles.css}">
    <link rel="stylesheet" href="/css/admin.css" th:href="@{/css/admin.css}">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Admin</title>
</head>
<body>
    <h1>Admin menu</h1>
    <div class="top-right-container">
        <p><b>Logged in as:</b></p>
        <p><span id="username" th:text="${username}">Username</span></p>
        <p><span th:text="${email}">email</span></p>
        <a href="/logout">Logout</a>
    </div>
    <div class="top-left-container">
        <p><b>Fun Games</b></p>
        <a href="/home">Home</a>
    </div>
    <div class="games-container">
        <p><b>Games</b></p>
        <a class="nav-link" href="/pexeso-menu">Pexeso</a>
        <a class="nav-link" href="/snake-game">Snake</a>
        <p><b>Leaderboards</b></p>
        <a class="nav-link" href="/leaderboards">Leaderboards</a>
        <p><b>Forum</b></p>
        <a class="nav-link" href="/forum">Forum</a>
        <p><b>Profiles</b></p>
        <a class="nav-link" onclick="redirectToUserProfile()">Your Profile</a>
        <a class="nav-link" href="/settings">Settings</a>
        <p><b>Admin</b></p>
        <a class="nav-link" href="/admin/admin-menu">Admin</a>
    </div>

    <script src="/js/dataOperations.js"></script>
    <script src="/js/profile.js" th:src="@{/js/profile.js}"></script> 

    <div class="sub-container-wrapper">
        <div class="sub-container">
            <form>
                <label for="entity">Entity:</label>
                <select id="entity" name="entity">
                    <option value="1">Users</option>
                    <option value="2">Posts</option>
                    <option value="3">Comments</option>
                </select>
                <button type="button" onclick="submitForm()">Show Entries</button>
            </form>
        </div>
    </div>

    <div class="sub-container-wrapper">
        <div class="sub-container">
            <h2>Entries</h2>
            <table id="resultsTable" class="results-table">
            </table>
        </div>

        <script>
            var global_bottom = 0;
            var global_top = 9;
            var global_entity = 1;
        
            function submitForm() {
                global_entity = document.getElementById("entity").value;
                
                let url;

                switch (global_entity) {
                    case '1':
                        url = "/users";
                        break;
                    case '2':
                        url = "/posts";
                        break;
                    case '3':
                        url = "/comments";
                        break;
                    default:
                        console.error('Invalid entity selection');
                        return;
                }

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        const resultsTable = document.getElementById("resultsTable");
                        resultsTable.innerHTML = "";  // Clear existing table data

                        // Create header row
                        let headerRow = resultsTable.insertRow();
                        let headers = [];
                        let fields = [];

                        if (global_entity === '1') {
                            headers = ["ID", "Username", "Email", "Avatar", "Actions"];
                            fields = ["id", "username", "email", "profilePictureURL", "actions"];
                        } else if (global_entity === '2') {
                            headers = ["Post ID", "Author", "Title", "Actions"];
                            fields = ["id", "user.username", "title", "actions"];
                        } else if (global_entity === '3') {
                            headers = ["Comment ID", "Post ID", "Author", "Actions"];
                            fields = ["id", "post.id", "user.username", "actions"];
                        }

                        headers.forEach(text => {
                            let headerCell = headerRow.insertCell();
                            headerCell.textContent = text;
                            headerCell.classList.add('table-header');
                        });

                        data.forEach(element => {
                            let row = resultsTable.insertRow();
                            fields.forEach((field, index) => {
                                let cell = row.insertCell();
                                if (field === "profilePictureURL" && global_entity === '1') {
                                    let img = document.createElement('img');
                                    img.src = element[field];
                                    img.alt = "Profile Picture";
                                    img.style.width = "50px";
                                    img.style.height = "50px";
                                    cell.appendChild(img);
                                } else if (field === "actions" && global_entity === '1') {
                                    let deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Delete';
                                    deleteButton.onclick = function() { deleteEntity(element.username); };
                                    cell.appendChild(deleteButton);
                                } else if (field === "actions" && global_entity === '2') {
                                    let deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Delete';
                                    deleteButton.onclick = function() { deleteEntity(element.id); };
                                    cell.appendChild(deleteButton);
                                } else if (field === "actions" && global_entity === '3') {
                                    let deleteButton = document.createElement('button');
                                    deleteButton.textContent = 'Delete';
                                    deleteButton.onclick = function() { deleteEntity(element.id); };
                                    cell.appendChild(deleteButton);
                                } else if (field === "user.username") {
                                    cell.textContent = element.user.username;
                                    cell.onclick = function() { viewProfile(element.user.username); };
                                    cell.classList.add('clickable');
                                } else if (field === "post.id") {
                                    cell.textContent = element.post.id;
                                    cell.onclick = function() { viewPost(element.post.id); };
                                    cell.classList.add('clickable');
                                } else if (field === "id" && global_entity === '2') {
                                    cell.textContent = element.id;
                                    cell.onclick = function() { viewPost(element.id); };
                                    cell.classList.add('clickable');
                                }
                                else {
                                    cell.textContent = element[field];
                                    if (field === "username") {
                                        cell.onclick = function() { viewProfile(element.username); };
                                        cell.classList.add('clickable');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Failed to fetch data:', error);
                    });
            }

            function deleteEntity(identifier) {
                if (global_entity === '1') {
                    deleteUser(identifier);
                } else if (global_entity === '2') {
                    deletePost(identifier);
                } else if (global_entity === '3') {
                    deleteComment(identifier);
                }
            }

            function deleteUser(username) {
                const csrfToken = document
                    .querySelector('meta[name="_csrf"]')
                    .getAttribute("content");
                const csrfHeader = document
                    .querySelector('meta[name="_csrf_header"]')
                    .getAttribute("content");
                const url = '/users/' + username;

                const requestOptions = {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                };

                fetch(url, requestOptions)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || 'Server error'); });
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log('User deleted:', data);
                        submitForm();
                    })
                    .catch(error => {
                        console.error('Failed to delete user:', error);
                    });

            }

            function deleteComment(identifier) {
                const csrfToken = document
                    .querySelector('meta[name="_csrf"]')
                    .getAttribute("content");
                const csrfHeader = document
                    .querySelector('meta[name="_csrf_header"]')
                    .getAttribute("content");
                const url = '/comments/' + identifier;

                const requestOptions = {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                };

                fetch(url, requestOptions)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || 'Server error'); });
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log('Comment deleted:', data);
                        submitForm();
                    })
                    .catch(error => {
                        console.error('Failed to delete comment:', error);
                    });
            
            }

            function deletePost(identifier) {
                const csrfToken = document
                    .querySelector('meta[name="_csrf"]')
                    .getAttribute("content");
                const csrfHeader = document
                    .querySelector('meta[name="_csrf_header"]')
                    .getAttribute("content");
                const url = '/posts/' + identifier;

                const requestOptions = {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    }
                };

                fetch(url, requestOptions)
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => { throw new Error(text || 'Server error'); });
                        }
                        return response.text();
                    })
                    .then(data => {
                        console.log('Post deleted:', data);
                        submitForm();
                    })
                    .catch(error => {
                        console.error('Failed to delete post:', error);
                    });
            }

            function viewProfile(username) {
                window.location.href = '/profile/' + username;
            }

            function viewPost(postId) {
                window.location.href = '/post/' + postId;
            }

        </script>        
       
</body>
</html>